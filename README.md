# Office 365 Group Sync Utility

[Git Repo](https://github.com/nathancrjackson/ps-o365-group-sync)

Unlike earlier types of groups the new Office 365 group type does not allow for nested group membership. While the Office 365 group type is still powerful in it's own right (with features like dynamic membership) you might want emulate a more traditional style of managing group membership.

## Description

This utility takes in which users and groups are mapped to your Office 365 group (defined in a JSON format), compiles those mappings into a flat user membership list and compares that list to the current membership of the Office 365 group. If you choose to the script can then update the current membership to match the generated membership.

## Use cases

The following are some possible use cases for this utility:
- Initial configuration of Office 365 groups.
- Having a rough security baseline for who should be members of Office 365 groups and tracking deviations from it.
- Enforcing strict membership for Office 365 groups*.

\* Not recommended

## Considerations

Please consider the following if you are going to use this utility in your tenant:
- **The utility is to be used at your own risk.**
- It appears to sometimes take a few minutes for changes made in the Azure AD portal to be available via PowerShell.
- The utility currently loads all users and groups from the Azure AD before verification. This works fine in the 100 user enviroment the script is tested with but may not scale that well.
- If you would like to use this utility to enforce strict membership it must be run after every change you make to the Azure AD that may affect Office 365 group membership.
- Office 365 groups being members of other Office 365 groups is not supported and has not been tested.
- Security groups that have dynamic membership enabled may also cause issues depending on you use case.

## Parameters

```
-LogFile [string]
```

Path to the file you would like to append the log to. Overrides the default one generated by the script which is: $ScriptNameWithoutExtension.log

```
-ConfigFile [string]
```

Path to the JSON file that contains your configuration. Overrides the default one generated by the script which is: $ScriptNameWithoutExtension.config.json

```
-FilenameAppend [string]
```

String to append after the script name and before the extension of script generated filenames: $ScriptNameWithoutExtension.$FilenameAppend.$Extension

```
-Commit [string]
```

*Default: No*

Set whether the script should commit the changes back to the Azure AD.

Values:
- Yes 
- No
- Prompt

```
-Username [string]
```

Username to connect to the Azure AD with. If password is not specified this will be passed onto the Microsoft login popup.

```
-Password [string]
```

Password for username. If this is specified a PSCredential will be generated and used to try to log into the Azure AD. If specified credentials are incorrect the utility will not give a Microsoft login popup.

```
-Credentials [PSCredential]
```

Credentials to log into Azure AD with. If specified credentials are incorrect the utility will not give a Microsoft login popup.

This overrides: Username, Password

```
-Connect [bool]
```

*Default: $TRUE*

Sets if the utility will try to connect to the Azure AD tenant.

This overrides: Username, Password & Credentials

```
-Disconnect [bool]
```

*Default: $TRUE*

Sets if the utility will disconnect from the Azure AD tenant when done or if you are connected to the wrong Azure AD tenant.

```
-Debug [bool]
```

*Default: $FALSE*

Set whether additional information is outputted to the console for debugging purposes.

## Configuration

**There is an example config file in the example folder**

Definition of the config file JSON:  

```
{
	"TenantPrefix" : STRING*,
	"GlobalGroups" : ARRAY OF STRINGS,
	"GlobalUsers" : ARRAY OF STRINGS
	"Mappings" : ARRAY OF MAPPINGOBJECTS*
}
```
(* = required)

Definition of MappingObject:  

```
{
	"Parent": STRING*,
	"ChildGroups" : ARRAY OF STRINGS,
	"ChildUsers" : ARRAY OF STRINGS
}
```
(* = required)



```
TenantPrefix
```

*Required*

The prefix for your onmicrosoft.com domain. For example if you have contoso.onmicrosoft.com the tenant prefix would be: contoso

When you are logged into the Azure AD this is used to check that you are connected to the correct tenant.

```
GlobalGroups
```

This is an array of groups that are members of every group mapped by this utility.

```
GlobalUsers
```

This is an array of users that are members of every group mapped by this utility.

```
Mappings
```

*Required*

This is an array of MappingObjects. This dictates which groups are managed by this utility and how those groups members are defined.

```
Parent
```

*Required*

This is the name of the group being managed.

```
ChildGroups
```

This is an array of groups that are members of the parent group.


```
ChildUsers
```

This is an array of users that are members of the parent group.

## Examples

**Example 1: Interactive run that autofills username in Microsoft login popup and after it displays changes gives you a prompt to commit changes**

```
& '.\Office365 Group Sync.ps1' -username "sysadmin@contoso.com" -commit "prompt"
```

*Note: If you are already connected with a different user it will use that connection to the Azure AD provided it is for the correct tenant. If you are already authenticated with the specified username but not connected with it the Microsoft login popup will be skipped and you will automatically connect.*

**Example 2: Non-interactive run that logs in with username and password then automatically commits changes**

```
& '.\Office365 Group Sync.ps1' -username "sysadmin@contoso.com" -password "1FastGate!" -commit "yes"
```

*Note: If you are already connected with a different user it will use that connection to the Azure AD provided it is for the correct tenant.*

## Possible future features

The following is a list of possible features in future updates:
- Checks to ensure current user can make changes to group memberships.
- Support for Azure Contexts.
- New parameter -ForceNonInteractive to ensure utility won't halt when run as a task.
- New parameter -Reconnect to force reconnection each time script run. Currently the script will use current authentication before trying provided credentials. Provided -Disconnect is $TRUE and you let the script finish this is already done.
- New parameter -LoadDataAsRequired to load data from Azure AD only as required. The utility currently pulls all users and all groups from the Azure AD before verification process.
- Deny Groups and Users at both the Global and Child level.
- An additional output file that details only changes to commit or that have been commited.